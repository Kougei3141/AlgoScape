<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>💖 成長するドラゴンAI「ぷぷ」</title>

  <!-- スタイル -->
  <link rel="stylesheet" href="style.css"/>

  <!-- 画像の先読み（任意） -->
  <link rel="preload" as="image" href="assets/logo.png">
  <link rel="preload" as="image" href="assets/egg.jpg">
  <link rel="preload" as="image" href="assets/hatchling.jpg">
  <link rel="preload" as="image" href="assets/coming_soon.png">
</head>
<body>
  <div class="container">
    <!-- ヘッダー -->
    <header class="header" role="banner" aria-label="アプリヘッダー">
      <div class="brand">
        <!-- ロゴ：差し替え自由（assets/logo.png に置く） -->
        <img src="assets/logo.png" alt="ぷぷロゴ" class="brand-logo" id="brandLogo" />
        <div class="brand-text">
          <h1 class="title">💖 成長するドラゴンAI「ぷぷ」</h1>
          <p class="subtitle">相棒として育つAI。ことばと体験で一緒に成長しよう。</p>
        </div>
      </div>
    </header>

    <!-- APIキー設定 -->
    <section class="api-setup" id="apiSetup" aria-label="APIキー設定">
      <h3>🔑 Gemini API キーの設定</h3>
      <p>Google AI Studioで取得したAPIキーを入力してください。（ブラウザにのみ保存）</p>
      <div class="api-row">
        <input type="password" class="api-input" id="apiKeyInput" placeholder="Gemini APIキーを入力..." autocomplete="off" />
        <button class="api-btn" id="saveApiKeyBtn">保存して開始</button>
      </div>
      <p class="help-text">※ APIキーはブラウザのローカルストレージに保存されます。サーバには送信されません。</p>
    </section>

    <!-- ステータスパネル -->
    <section class="status-panel" aria-label="ステータス">
      <div class="phase">
        <div class="phase-indicator" id="phaseIcon" aria-hidden="true">🥚</div>
        <div class="phase-name" id="phaseName">たまごドラゴン</div>
      </div>
      <div class="stats" role="group" aria-label="数値ステータス">
        <div class="stat">
          <div class="stat-value" id="loveCount">0</div>
          <div class="stat-label">愛情度</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="vocabCount">0</div>
          <div class="stat-label">語彙数</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="responseCount">0</div>
          <div class="stat-label">会話回数</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="structureLevel">1</div>
          <div class="stat-label">構文レベル</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="masteredPercent">0%</div>
          <div class="stat-label">習熟率</div>
        </div>
      </div>
      <div class="progress-bar" aria-label="次フェーズ進捗">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </section>

    <!-- キャラクター表示（画像はJSで差し替え） -->
    <section class="ai-character-display" id="aiCharacterDisplayArea" style="display:none;" aria-live="polite">
      <!-- 画像差し替えポイント：
           ・たまご：assets/egg.jpg
           ・孵化〜幼竜：assets/hatchling.jpg
           ・成長竜が未完成の間：assets/coming_soon.png
           JSのPHASES_CONFIG.imageがこれらのいずれかを指すようにしてある前提。 -->
      <picture>
        <img id="aiCharacterImage" src="assets/egg.jpg" alt="ぷぷの姿" />
      </picture>

      <div id="aiSpeechBubble" class="speech-bubble" style="display:none;">
        <p id="aiSpeechText"></p>
      </div>
    </section>

    <!-- チャット -->
    <main class="chat" role="main">
      <div class="chat-area" id="chatArea" aria-live="polite" aria-label="会話履歴"></div>
      <div id="loading" class="loading-indicator" style="display:none;">ぷぷ考え中... 🤔</div>

      <div class="input-area">
        <label for="userInput" class="sr-only">メッセージ入力</label>
        <input type="text" class="input-field" id="userInput" placeholder="ぷぷに話しかけてね..." disabled />
        <button class="send-btn" id="sendButton" disabled>送信</button>
      </div>
    </main>

    <!-- コントロール -->
    <nav class="controls" aria-label="操作">
      <button class="control-btn" id="statusButton">📊 詳細ステータス</button>
      <button class="control-btn" id="resetButton">🔄 リセット</button>
      <button class="control-btn" id="teachButton">📚 単語を教える</button>
      <button class="control-btn" id="showApiSetupBtn">🔑 APIキー設定</button>
      <!-- ゲーム名を学習向けにリネーム（IDは既存互換） -->
      <button class="control-btn" id="startGame1Btn">トークナイザー研究所</button>
      <button class="control-btn" id="startGame2Btn">アルゴスケイプ（強化学習）</button>
      <button class="control-btn" id="startGame3Btn">しりとり（分布の感覚）</button>
    </nav>
  </div>

  <!-- 進化お祝いモーダル -->
  <div class="celebration" id="celebrationModal" role="dialog" aria-modal="true" aria-labelledby="celebrationText" style="display:none;">
    <h2>🎉 おめでとう！</h2>
    <div id="celebrationPhaseIcon" class="phase-icon-large" aria-hidden="true"></div>
    <p id="celebrationText"></p>
    <ul id="celebrationFeatures" class="features-list"></ul>
    <button id="closeCelebrationBtn" class="btn-primary">わかった！</button>
  </div>

  <!-- ミニゲームモーダル -->
  <div id="miniGameModal" class="modal-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="miniGameTitle">
    <div class="modal-content">
      <button id="closeMiniGameBtn" class="modal-close" aria-label="閉じる">×</button>
      <h3 id="miniGameTitle">ミニゲームタイトル</h3>
      <div id="miniGameArea"></div>
    </div>
  </div>

  <!-- Game1: トークナイザー研究所（旧ことば集めテンプレ互換） -->
  <template id="wordCollectGameTemplate">
    <p>テーマ: <span id="wordCollectTheme"></span></p>
    <p>制限時間: <span id="wordCollectTimeLeft">40</span>秒 | スコア: <span id="wordCollectScore">0</span></p>
    <div id="wordCollectObjectsArea"></div>
    <p id="wordCollectMessage" class="game-hint"></p>
  </template>

  <!-- Game2: アルゴスケイプ（強化学習ごっこ） -->
  <template id="errandGameTemplate">
    <p id="errandObjective">目的: </p>
    <div id="errandMapArea">
      <div id="errandPlayer" title="ぷぷ">🐲</div>
    </div>
    <div id="errandControls" class="dpad">
      <button data-direction="up" aria-label="上へ">↑</button>
      <button data-direction="down" aria-label="下へ">↓</button>
      <button data-direction="left" aria-label="左へ">←</button>
      <button data-direction="right" aria-label="右へ">→</button>
    </div>
    <p id="errandMessage" class="game-hint"></p>
  </template>

  <!-- Game3: しりとり（分布の感覚） -->
  <template id="shiritoriGameTemplate">
    <p>前の言葉: <strong id="shiritoriPrevWord">しりとり</strong></p>
    <p id="shiritoriTurnIndicator" class="turn-indicator"></p>
    <div class="shiritori-input">
      <input type="text" id="shiritoriUserInput" placeholder="次の言葉を入力..." inputmode="kana" />
      <button id="shiritoriSubmitBtn">決定</button>
    </div>
    <p id="shiritoriMessage" class="game-hint"></p>
    <ul id="shiritoriHistory" class="history-list"></ul>
  </template>

  <!-- スクリプト（前の回答の script.js をそのまま置く） -->
  <script src="script.js"></script>

  <!-- 画像が未設定/壊れた場合のフォールバック（任意） -->
  <script>
    // 画像のフォールバック：読み込み失敗時は coming_soon に差し替え
    window.addEventListener('error', (e) => {
      const el = e.target;
      if (el && el.tagName === 'IMG' && el.id === 'aiCharacterImage') {
        el.src = 'assets/coming_soon.png';
      }
    }, true);
  </script>
</body>
</html>
